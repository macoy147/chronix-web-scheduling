<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONIX - Manage Schedules</title>
    <link rel="icon" type="image/png" href="/img/img/CHRONIX_LOGO.png">
    <link rel="stylesheet" href="/css/admin-schedules.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="admin-nav">
        <div class="nav-left">
            <img src="/img/img/CTU_new_logo-removebg-preview.png" alt="CTU Logo" class="admin-logo">
            <img src="/img/img/CHRONIX_LOGO.png" alt="CHRONIX Logo" class="admin-logo">
            <span class="admin-app-title">CHRONIX</span>
        </div>
        
        <ul class="nav-links">
            <li><a href="admin-dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
            <li><a href="admin-subjects.html"><i class="bi bi-book"></i> Subjects</a></li>
            <li><a href="admin-sections.html"><i class="bi bi-layers"></i> Sections</a></li>
            <li><a href="admin-rooms.html"><i class="bi bi-door-open"></i> Rooms</a></li>
            <li class="active"><a href="admin-schedules.html"><i class="bi bi-calendar-event"></i> Schedules</a></li>
            <li><a href="admin-students.html"><i class="bi bi-mortarboard"></i> Students</a></li>
            <li><a href="admin-teachers.html"><i class="bi bi-person-badge"></i> Teachers</a></li>
        </ul>
        <div class="nav-right">
            <div class="admin-profile-dropdown">
                <img id="profileAvatar" src="./img/default_admin_avatar.png" alt="Admin Avatar" class="profile-img">
                <span class="profile-name" id="profileName">Admin <i class="bi bi-chevron-down"></i></span>
                <div class="profile-dropdown">
                    <a href="admin-profile.html"><i class="bi bi-person"></i> Profile</a>
                    <a href="#" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="admin-schedules-main">
        <div class="admin-center-container">
            <!-- Statistics Dashboard -->
            <div class="statistics-dashboard" id="statisticsDashboard">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e3f2fd;">
                        <i class="bi bi-calendar-check" style="color: #1976d2;"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="totalSchedulesCount">0</div>
                        <div class="stat-label">Total Schedules</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: #fff3e0;">
                        <i class="bi bi-door-open" style="color: #f57c00;"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="roomUtilization">0%</div>
                        <div class="stat-label">Room Utilization</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f3e5f5;">
                        <i class="bi bi-person-badge" style="color: #7b1fa2;"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="teacherWorkload">0</div>
                        <div class="stat-label">Avg Teacher Hours</div>
                    </div>
                </div>
                
                <div class="stat-card stat-conflict">
                    <div class="stat-icon" style="background: #ffebee;">
                        <i class="bi bi-exclamation-triangle" style="color: #d32f2f;"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="conflictsCount">0</div>
                        <div class="stat-label">Conflicts Detected</div>
                    </div>
                </div>
            </div>

            <!-- Controls Container -->
            <div class="controls-container">
                <!-- Left Side: Section Selector -->
                <div class="section-selector">
                    <label>Year and Section: *</label>
                    <div class="custom-dropdown" id="customSectionDropdown">
                        <div class="dropdown-trigger" id="dropdownTrigger">
                            <span id="selectedSection">Select Year and Section</span>
                            <button class="clear-selection-btn" id="clearSelectionBtn" style="display: none;" title="Clear selection">
                                <i class="bi bi-x-circle-fill"></i>
                            </button>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                        <div class="dropdown-menu" id="dropdownMenu">
                            <div class="dropdown-columns">
                                <div class="dropdown-column">
                                    <div class="column-header">Year 1</div>
                                    <div class="column-items" id="year1Items">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                                <div class="dropdown-column">
                                    <div class="column-header">Year 2</div>
                                    <div class="column-items" id="year2Items">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                                <div class="dropdown-column">
                                    <div class="column-header">Year 3</div>
                                    <div class="column-items" id="year3Items">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                                <div class="dropdown-column">
                                    <div class="column-header">Year 4</div>
                                    <div class="column-items" id="year4Items">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Hidden select for form compatibility -->
                    <select id="sectionFilterSelect" style="display: none;">
                        <option value="">Select Year and Section</option>
                        <!-- Populated by JS with all sections -->
                    </select>
                </div>
                
                <!-- Right Side: Action Buttons -->
                <div class="action-buttons">
                    <button class="schedule-create-btn" id="openScheduleModal">
                        <i class="bi bi-plus-circle"></i> Create New Schedule
                    </button>
                    <button class="export-schedule-btn" id="exportScheduleBtn">
                        <i class="bi bi-download"></i> Export Schedules
                    </button>
                </div>
            </div>

            <!-- Calendar Header -->
            <div class="calendar-header">
                <button class="nav-btn" id="prevWeekBtn">
                    <i class="bi bi-chevron-left"></i>
                </button>
                
                <div class="calendar-title">
                    <div class="week-info">
                        <h2 id="currentWeekRange">Week of Jan 1 - Jan 7, 2024</h2>
                        <span class="week-number" id="weekNumber">Week 1</span>
                    </div>
                    <button class="today-btn" id="todayBtn">
                        <i class="bi bi-calendar-today"></i> Today
                    </button>
                </div>
                
                <button class="nav-btn" id="nextWeekBtn">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>

            <!-- Calendar Grid -->
            <div class="calendar-container">
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calendar will be populated by JavaScript -->
                </div>
            </div>

            <!-- Subject Assignment Container -->
            <div class="subject-assignment-container" id="subjectAssignmentContainer">
                <!-- Dynamic subject assignments will appear here -->
            </div>
        </div>
    </main>

    <!-- Create/Edit Schedule Modal - COMPACT VERSION -->
    <div id="scheduleModal" class="modal-overlay" style="display:none;">
        <div class="modal-content schedule-modal compact">
            <h3 id="scheduleModalTitle">Create New Schedule</h3>
            
            <!-- Conflict Alert -->
            <div id="conflictAlert" class="conflict-alert" style="display:none;">
                <i class="bi bi-exclamation-triangle"></i>
                <div class="conflict-message">
                    <strong>Schedule Conflict!</strong>
                    <span id="conflictDetails"></span>
                </div>
                <div class="recommendations" id="recommendations">
                    <!-- Recommendations will be populated here -->
                </div>
            </div>

            <form id="scheduleForm">
                <div class="form-grid compact">
                    <div class="form-row compact">
                        <label>Subject *</label>
                        <select name="subject" id="subjectSelect" class="compact-dropdown" required title="Select Subject">
                            <option value="">Select Subject</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    
                    <div class="form-row compact">
                        <label>Teacher *</label>
                        <select name="teacher" id="teacherSelect" class="compact-dropdown" required title="Select Teacher">
                            <option value="">Select Teacher</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    
                    <div class="form-row compact">
                        <label>Section *</label>
                        <select name="section" id="sectionSelect" class="compact-dropdown" required title="Select Section">
                            <option value="">Select Section</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    
                    <div class="form-row compact">
                        <label>Room *</label>
                        <select name="room" id="roomSelect" class="compact-dropdown" required title="Select Room">
                            <option value="">Select Room</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    
                    <div class="form-row compact">
                        <label>Day *</label>
                        <select name="day" id="daySelect" class="compact-input" required>
                            <option value="">Select Day</option>
                            <option value="Monday">Mon</option>
                            <option value="Tuesday">Tue</option>
                            <option value="Wednesday">Wed</option>
                            <option value="Thursday">Thu</option>
                            <option value="Friday">Fri</option>
                            <option value="Saturday">Sat</option>
                        </select>
                    </div>
                    
                    <div class="form-row compact">
                        <label>Start Time *</label>
                        <input type="time" name="startTime" id="startTime" class="compact-input" required>
                    </div>
                    
                    <div class="form-row compact">
                        <label>End Time *</label>
                        <input type="time" name="endTime" id="endTime" class="compact-input" required>
                    </div>                    
                    <div class="form-row full-width">
                        <label>Schedule Type</label>
                        <div class="schedule-type-toggle compact">
                            <label class="type-option">
                                <input type="radio" name="scheduleType" value="lecture" checked>
                                <span>Lecture</span>
                            </label>
                            <label class="type-option">
                                <input type="radio" name="scheduleType" value="lab">
                                <span>Lab</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Subject Hours Info (updated for per section) -->
                <div class="subject-hours-info" id="subjectHoursInfo" style="display:none;">
                    <div class="hours-breakdown">
                        <strong>Hours for this Section:</strong>
                        <span id="lecHours">0/0</span> Lec | 
                        <span id="labHours">0/0</span> Lab |
                        <span id="totalHours">0/0</span> Total
                    </div>
                    <div class="hours-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="hoursProgress"></div>
                        </div>
                        <span class="progress-text" id="progressText">0% scheduled</span>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="modal-cancel" id="closeScheduleModal">Cancel</button>
                    <button type="submit" class="modal-submit" id="submitScheduleBtn">Create Schedule</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Schedule Details Modal -->
    <div id="scheduleDetailsModal" class="modal-overlay" style="display:none;">
        <div class="modal-content" style="max-width:400px;">
            <h3>Schedule Details</h3>
            <div class="schedule-details" id="scheduleDetails">
                <!-- Populated by JS -->
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-cancel" id="closeDetailsModal">Close</button>
                <button type="button" class="modal-submit" id="editScheduleBtn">Edit</button>
                <button type="button" class="modal-delete" id="deleteScheduleBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Bubble Notification -->
    <div id="scheduleBubbleMessage" class="section-bubble-message"></div>

<script type="module" src="/js/api-config.js"></script>
<script type="module" src="/js/error-handler.js"></script>
<script type="module" src="/js/auth-guard.js"></script>
<script type="module" src="/js/admin-schedules.js"></script>

<!-- Custom Dropdown Handler -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropdownTrigger = document.getElementById('dropdownTrigger');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const selectedSection = document.getElementById('selectedSection');
    const hiddenSelect = document.getElementById('sectionFilterSelect');
    
    // Toggle dropdown
    if (dropdownTrigger) {
        dropdownTrigger.addEventListener('click', function(e) {
            // Don't toggle if clicking the clear button
            if (e.target.closest('.clear-selection-btn')) {
                return;
            }
            e.stopPropagation();
            dropdownTrigger.classList.toggle('active');
            dropdownMenu.classList.toggle('show');
        });
    }
    
    // Clear button handler
    const clearBtn = document.getElementById('clearSelectionBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            clearSelection();
        });
    }
    
    // Export All option handler
    const exportAllOption = document.getElementById('exportAllOption');
    if (exportAllOption) {
        exportAllOption.addEventListener('click', function(e) {
            e.stopPropagation();
            clearSelection(); // Clear selection to export all
        });
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.custom-dropdown')) {
            dropdownTrigger?.classList.remove('active');
            dropdownMenu?.classList.remove('show');
        }
    });
    
    // Handle item selection
    function handleItemClick(item) {
        const value = item.dataset.value;
        const text = item.textContent;
        const wasSelected = item.classList.contains('selected');
        
        // If clicking the already selected item, deselect it
        if (wasSelected) {
            clearSelection();
            return;
        }
        
        // Update display
        selectedSection.textContent = text;
        
        // Update hidden select
        hiddenSelect.value = value;
        
        // Trigger change event on hidden select
        const event = new Event('change', { bubbles: true });
        hiddenSelect.dispatchEvent(event);
        
        // Update selected state
        document.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
        item.classList.add('selected');
        
        // Show clear button
        showClearButton();
        
        // Close dropdown
        dropdownTrigger.classList.remove('active');
        dropdownMenu.classList.remove('show');
    }
    
    // Clear selection function
    function clearSelection() {
        // Reset display
        selectedSection.textContent = 'Select Year and Section';
        
        // Clear hidden select
        hiddenSelect.value = '';
        
        // Trigger change event
        const event = new Event('change', { bubbles: true });
        hiddenSelect.dispatchEvent(event);
        
        // Remove selected state from all items
        document.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
        
        // Hide clear button
        hideClearButton();
        
        // Close dropdown
        dropdownTrigger.classList.remove('active');
        dropdownMenu.classList.remove('show');
    }
    
    // Show/hide clear button
    function showClearButton() {
        const clearBtn = document.getElementById('clearSelectionBtn');
        if (clearBtn) {
            clearBtn.style.display = 'flex';
        }
    }
    
    function hideClearButton() {
        const clearBtn = document.getElementById('clearSelectionBtn');
        if (clearBtn) {
            clearBtn.style.display = 'none';
        }
    }
    
    // Populate dropdown from hidden select (when sections are loaded)
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' && hiddenSelect.options.length > 1) {
                populateCustomDropdown();
                observer.disconnect();
            }
        });
    });
    
    if (hiddenSelect) {
        observer.observe(hiddenSelect, { childList: true, subtree: true });
    }
    
    function populateCustomDropdown() {
        const year1Items = document.getElementById('year1Items');
        const year2Items = document.getElementById('year2Items');
        const year3Items = document.getElementById('year3Items');
        const year4Items = document.getElementById('year4Items');
        
        if (!year1Items || !year2Items || !year3Items || !year4Items) return;
        
        year1Items.innerHTML = '';
        year2Items.innerHTML = '';
        year3Items.innerHTML = '';
        year4Items.innerHTML = '';
        
        Array.from(hiddenSelect.options).forEach(option => {
            if (!option.value) return; // Skip empty option
            
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.dataset.value = option.value;
            item.textContent = option.text;
            
            item.addEventListener('click', function() {
                handleItemClick(this);
            });
            
            // Determine which column based on year level
            const yearMatch = option.text.match(/Year (\d)/i) || option.text.match(/(\d)[A-Z]/);
            if (yearMatch) {
                const year = parseInt(yearMatch[1]);
                switch(year) {
                    case 1:
                        year1Items.appendChild(item);
                        break;
                    case 2:
                        year2Items.appendChild(item);
                        break;
                    case 3:
                        year3Items.appendChild(item);
                        break;
                    case 4:
                        year4Items.appendChild(item);
                        break;
                    default:
                        year1Items.appendChild(item);
                }
            } else {
                // Default to first column if year can't be determined
                year1Items.appendChild(item);
            }
        });
    }
    
    // Initial population if options already exist
    if (hiddenSelect && hiddenSelect.options.length > 1) {
        populateCustomDropdown();
    }
});
</script>

<!-- Mobile detection and redirection -->
<script>
// Mobile detection and redirection
function isMobileDevice() {
    return window.innerWidth <= 768 || 
           /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Prevent redirect loops
let lastRedirectTime = 0;
const REDIRECT_COOLDOWN = 1000;

function shouldRedirectToMobile() {
    const now = Date.now();
    if (now - lastRedirectTime < REDIRECT_COOLDOWN) {
        return false;
    }
    
    return isMobileDevice() && !window.location.pathname.includes('-mobile');
}

// Initial redirect check
if (shouldRedirectToMobile()) {
    lastRedirectTime = Date.now();
    console.log('Redirecting to mobile version...');
    window.location.href = '/admin-schedules-mobile.html';
}

// Handle resize events
let resizeTimeout;
window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
        if (shouldRedirectToMobile()) {
            lastRedirectTime = Date.now();
            console.log('Screen resized - redirecting to mobile version...');
            window.location.href = '/admin-schedules-mobile.html';
        }
    }, 250);
});
</script>
</body>
</html>
